<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GK Visual Tracking — Xamax</title>
  <style>
    :root{
      --xamax-red:#e10600;
      --bg:#0b0b0b;
      --panel: rgba(10,10,10,.72);
      --stroke:#242424;
      --text:#e9e9e9;
      --muted:#bdbdbd;
    }

    html, body { margin:0; height:100%; background:#070707; font-family: system-ui, -apple-system, Segoe UI, Roboto; color:var(--text); }
    #wrap { display:flex; height:100%; align-items:center; justify-content:center; padding:12px; }
    canvas { background:var(--bg); border:1px solid var(--stroke); border-radius:16px; touch-action: manipulation; }

    /* Top bar */
    #topbar{
      position: fixed; left: 12px; right:12px; top: 12px;
      display:flex; align-items:center; justify-content:space-between;
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: 16px;
      padding: 10px 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 10;
    }
    #brand{ display:flex; align-items:center; gap:10px; min-width: 0; }
    #brand img{ height:28px; width:auto; display:block; }
    #brand .title{
      font-weight: 800; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    #brand .subtitle{ font-size:12px; color:var(--muted); margin-top:1px; }

    .btn{
      padding: 8px 10px;
      background: rgba(255,255,255,.06);
      color: var(--text);
      border:1px solid var(--stroke);
      border-radius: 12px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn.primary{
      background: rgba(225,6,0,.22);
      border-color: rgba(225,6,0,.55);
    }
    .btn.primary:hover{ background: rgba(225,6,0,.30); }

    /* Drawer / menu */
    #drawer{
      position: fixed; right: 12px; top: 64px;
      width: 360px;
      max-width: calc(100vw - 24px);
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: 16px;
      padding: 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 10;
      transform: translateY(-6px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease;
    }
    #drawer.open{
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .row{ margin: 10px 0; }
    .rowline{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .label{ color: var(--muted); font-size:12px; }
    .val{ font-weight: 800; }
    input[type="range"]{ width: 220px; }
    #mini{
      position: fixed; left: 12px; bottom: 12px;
      background: rgba(10,10,10,.55);
      border:1px solid var(--stroke);
      border-radius: 14px;
      padding: 10px 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 9;
      max-width: calc(100vw - 24px);
    }
    #mini .kpi{ display:flex; gap:14px; flex-wrap:wrap; align-items:baseline; }
    #mini b{ color:#fff; }
    #bar { height: 6px; background: rgba(255,255,255,.08); border:1px solid var(--stroke); border-radius: 999px; overflow:hidden; margin-top:8px; }
    #fill { height:100%; width:0%; background: var(--xamax-red); }
    .hint{ font-size:12px; color: var(--muted); margin-top:6px; line-height: 1.25; }
    kbd { background: rgba(255,255,255,.06); border:1px solid var(--stroke); padding:2px 6px; border-radius:8px; color:#fff; }

    /* Small screens */
    @media (max-width: 520px){
      #drawer{ width: calc(100vw - 24px); }
      input[type="range"]{ width: 200px; }
    }
  </style>
</head>

<body>
  <div id="wrap">
  <canvas id="c" width="1200" height="720"></canvas>  </div>

  <!-- Topbar -->
  <div id="topbar">
    <div id="brand">
      <img id="logo" alt="Logo" />
      <div style="min-width:0">
        <div class="title">GK Visual Tracking</div>
        <div class="subtitle">Mode Xamax — STOP → ESPACE révèle</div>
      </div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button class="btn primary" id="startBtn">Nouvel essai</button>
      <button class="btn" id="toggleBtn">☰</button>
    </div>
  </div>

  <!-- Drawer -->
  <div id="drawer">
    <div class="rowline">
      <div>
        <div style="font-weight:800">Réglages</div>
        <div class="label">Ajuste avant l’essai (ou entre essais)</div>
      </div>
      <button class="btn" id="revealBtn">Révéler</button>
    </div>

    <div class="row">
      <div class="rowline">
        <div>
          <div class="label">Vitesse</div>
          <div class="val"><span id="speedVal"></span></div>
        </div>
        <input id="speed" type="range" min="60" max="520" step="10" />
      </div>
    </div>

    <div class="row">
      <div class="rowline">
        <div>
          <div class="label">Durée mouvement (s)</div>
          <div class="val"><span id="moveVal"></span></div>
        </div>
        <input id="move" type="range" min="2" max="20" step="1" />
      </div>
    </div>

    <div class="row">
      <div class="rowline">
        <div>
          <div class="label">Cible visible (ms)</div>
          <div class="val"><span id="cueVal"></span></div>
        </div>
        <input id="cue" type="range" min="300" max="2500" step="100" />
      </div>
    </div>

    <div class="row">
      <div class="rowline">
        <div>
          <div class="label">Nb objets</div>
          <div class="val"><span id="nVal"></span></div>
        </div>
        <input id="nDots" type="range" min="4" max="22" step="1" />
      </div>
    </div>

    <div class="row">
      <div class="rowline">
        <div>
          <div class="label">Chaos</div>
          <div class="val"><span id="chaosVal"></span></div>
        </div>
        <input id="chaos" type="range" min="0" max="0.9" step="0.05" />
      </div>
    </div>

    <div class="row">
      <div class="rowline">
        <div>
          <div class="label">Taille des boules</div>
          <div class="val"><span id="radiusVal"></span> px</div>
        </div>
        <input id="radius" type="range" min="10" max="28" step="1" />
      </div>
    </div>

    <div class="hint">
      Raccourcis: <kbd>Espace</kbd> nouvel essai • (en STOP) <kbd>Espace</kbd> révèle • <kbd>R</kbd> révèle
    </div>
  </div>

  <!-- Mini HUD -->
  <div id="mini">
    <div class="kpi">
      <div>Phase: <b id="phase">—</b></div>
      <div>Essais: <b id="trials">0</b></div>
      <div>Temps: <b id="time">0.00</b>s</div>
    </div>
    <div id="bar"><div id="fill"></div></div>
  </div>

<script>
(() => {
  // ===== LOGO PATH =====
  // Mets ici le chemin exact du logo dans ton repo:
  // ex: "assets/xamax.png" ou "xamax.png"
  const LOGO_PATH = "xamaxlogo.png";

  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  const logoEl = document.getElementById('logo');
  logoEl.src = LOGO_PATH;

  // ====== PARAMÈTRES ======
  const CONFIG = {
    nDots: 10,
    radius: 18,        // boules plus grandes par défaut
    chaos: 0.35,
    speed: 260,
    showTargetMs: 900,
    moveMs: 7000,
    bounce: true,
  };

  // ====== UI ======
  const phaseEl = document.getElementById('phase');
  const trialsEl = document.getElementById('trials');
  const timeEl = document.getElementById('time');
  const fillEl = document.getElementById('fill');

  const startBtn = document.getElementById('startBtn');
  const revealBtn = document.getElementById('revealBtn');
  const toggleBtn = document.getElementById('toggleBtn');
  const drawer = document.getElementById('drawer');

  const speedSlider = document.getElementById('speed');
  const moveSlider  = document.getElementById('move');
  const cueSlider   = document.getElementById('cue');
  const nSlider     = document.getElementById('nDots');
  const chaosSlider = document.getElementById('chaos');
  const radiusSlider= document.getElementById('radius');

  const speedValEl = document.getElementById('speedVal');
  const moveValEl  = document.getElementById('moveVal');
  const cueValEl   = document.getElementById('cueVal');
  const nValEl     = document.getElementById('nVal');
  const chaosValEl = document.getElementById('chaosVal');
  const radiusValEl= document.getElementById('radiusVal');

  function syncControlsFromConfig() {
    speedSlider.value = CONFIG.speed;
    moveSlider.value  = Math.round(CONFIG.moveMs / 1000);
    cueSlider.value   = CONFIG.showTargetMs;
    nSlider.value     = CONFIG.nDots;
    chaosSlider.value = CONFIG.chaos;
    radiusSlider.value= CONFIG.radius;

    speedValEl.textContent = CONFIG.speed;
    moveValEl.textContent  = (CONFIG.moveMs / 1000).toFixed(0);
    cueValEl.textContent   = CONFIG.showTargetMs;
    nValEl.textContent     = CONFIG.nDots;
    chaosValEl.textContent = CONFIG.chaos.toFixed(2);
    radiusValEl.textContent= CONFIG.radius;
  }

  function applyControlsToConfig() {
    CONFIG.speed = parseInt(speedSlider.value, 10);
    CONFIG.moveMs = parseInt(moveSlider.value, 10) * 1000;
    CONFIG.showTargetMs = parseInt(cueSlider.value, 10);
    CONFIG.nDots = parseInt(nSlider.value, 10);
    CONFIG.chaos = parseFloat(chaosSlider.value);
    CONFIG.radius = parseInt(radiusSlider.value, 10);

    speedValEl.textContent = CONFIG.speed;
    moveValEl.textContent  = (CONFIG.moveMs / 1000).toFixed(0);
    cueValEl.textContent   = CONFIG.showTargetMs;
    nValEl.textContent     = CONFIG.nDots;
    chaosValEl.textContent = CONFIG.chaos.toFixed(2);
    radiusValEl.textContent= CONFIG.radius;
  }

  [speedSlider, moveSlider, cueSlider, nSlider, chaosSlider, radiusSlider]
    .forEach(el => el.addEventListener('input', applyControlsToConfig));

  // ====== état ======
  let dots = [];
  let targetId = 0;
  let phase = 'idle'; // idle | cue | waiting | stopped | revealed
  let t0 = 0;
  let last = 0;
  let trials = 0;
  let reveal = false;

  const BG = '#0b0b0b';
  const DOT = '#e6e6e6';
  const TARGET_CUE = '#ff3b30';
  const REVEAL_OK = '#34c759';

  function rand(min, max) { return Math.random() * (max - min) + min; }
  function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

  function resizeToFit() {
    const maxW = window.innerWidth - 24;
    const maxH = window.innerHeight - 24;
    const aspect = 900/520;

    let w = Math.min(900, maxW);
    let h = w / aspect;
    if (h > maxH) { h = Math.min(520, maxH); w = h * aspect; }

    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
  }
  window.addEventListener('resize', resizeToFit);
  resizeToFit();

  function initTrial() {
    applyControlsToConfig();
    trials++;
    trialsEl.textContent = trials;
    reveal = false;

    const W = canvas.width, H = canvas.height;
    dots = [];
    for (let i = 0; i < CONFIG.nDots; i++) {
      const angle = rand(0, Math.PI * 2);
      const sp = rand(CONFIG.speed * 0.75, CONFIG.speed * 1.25);
      dots.push({
        id: i,
        x: rand(CONFIG.radius, W - CONFIG.radius),
        y: rand(CONFIG.radius, H - CONFIG.radius),
        vx: Math.cos(angle) * sp,
        vy: Math.sin(angle) * sp,
      });
    }
    targetId = Math.floor(rand(0, CONFIG.nDots));

    phase = 'cue';
    phaseEl.textContent = 'CIBLE';
    t0 = performance.now();
    last = t0;
    requestAnimationFrame(loop);
  }

  function revealTarget() {
    reveal = true;
    phase = 'revealed';
    phaseEl.textContent = 'RÉVÉLÉ';
  }

  function step(dt) {
    const W = canvas.width, H = canvas.height;

    for (const d of dots) {
      d.vx += rand(-1, 1) * CONFIG.chaos * 60;
      d.vy += rand(-1, 1) * CONFIG.chaos * 60;

      const sp = Math.hypot(d.vx, d.vy) || 1;
      const desired = CONFIG.speed;
      d.vx = (d.vx / sp) * (desired + rand(-20, 20));
      d.vy = (d.vy / sp) * (desired + rand(-20, 20));

      d.x += d.vx * dt;
      d.y += d.vy * dt;

      if (CONFIG.bounce) {
        if (d.x < CONFIG.radius) { d.x = CONFIG.radius; d.vx *= -1; }
        if (d.x > W - CONFIG.radius) { d.x = W - CONFIG.radius; d.vx *= -1; }
        if (d.y < CONFIG.radius) { d.y = CONFIG.radius; d.vy *= -1; }
        if (d.y > H - CONFIG.radius) { d.y = H - CONFIG.radius; d.vy *= -1; }
      }
    }
  }

  function draw(now) {
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0, 0, W, H);

    ctx.fillStyle = BG;
    ctx.fillRect(0, 0, W, H);

    const elapsed = (now - t0) / 1000;
    timeEl.textContent = elapsed.toFixed(2);

    const totalMsToStop = CONFIG.showTargetMs + CONFIG.moveMs;
    const p = clamp((now - t0) / totalMsToStop, 0, 1);
    fillEl.style.width = (p * 100).toFixed(1) + '%';

    for (const d of dots) {
      let color = DOT;
      if (phase === 'cue' && d.id === targetId) color = TARGET_CUE;
      if (reveal && d.id === targetId) color = REVEAL_OK;

      ctx.beginPath();
      ctx.arc(d.x, d.y, CONFIG.radius, 0, Math.PI * 2);
      ctx.fillStyle = color;
      ctx.fill();

      ctx.lineWidth = 2;
      ctx.strokeStyle = '#111';
      ctx.stroke();
    }

    ctx.fillStyle = 'rgba(255,255,255,.85)';
    ctx.font = '18px system-ui, -apple-system, Segoe UI, Roboto';
    if (phase === 'cue') ctx.fillText('Cible visible (rouge)', 18, 34);
    if (phase === 'waiting') ctx.fillText('Tout identique — tracking', 18, 34);
    if (phase === 'stopped') ctx.fillText('STOP — ESPACE pour révéler', 18, 34);
    if (phase === 'revealed') ctx.fillText('Révélé', 18, 34);
  }

  function loop(now) {
    const dt = (now - last) / 1000;
    last = now;
    const ms = now - t0;

    if (phase === 'cue' && ms >= CONFIG.showTargetMs) {
      phase = 'waiting';
      phaseEl.textContent = 'TRACK';
    }

    if (phase === 'cue' || phase === 'waiting') step(dt);

    if (phase === 'waiting' && ms >= (CONFIG.showTargetMs + CONFIG.moveMs)) {
      phase = 'stopped';
      phaseEl.textContent = 'STOP';
    }

    draw(now);
    if (phase !== 'idle') requestAnimationFrame(loop);
  }

  // UI interactions
  toggleBtn.addEventListener('click', () => drawer.classList.toggle('open'));
  startBtn.addEventListener('click', initTrial);
  revealBtn.addEventListener('click', () => { if (phase === 'stopped' && !reveal) revealTarget(); });

  document.addEventListener('keydown', (e) => {
    const k = e.key.toLowerCase();
    if (e.code === 'Space') {
      e.preventDefault();
      if (phase === 'stopped' && !reveal) revealTarget();
      else initTrial();
    }
    if (k === 'r') { if (phase === 'stopped' && !reveal) revealTarget(); }
    if (k === 'm') drawer.classList.toggle('open'); // petit bonus
  });

  syncControlsFromConfig();
  applyControlsToConfig();
  initTrial();
})();
</script>
</body>
</html>
